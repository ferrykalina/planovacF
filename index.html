<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <title>Pl√°novaƒç (Supabase Realtime)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://unpkg.com/@supabase/supabase-js@2.45.3/dist/umd/supabase.js"></script>
  <style>
    .col{min-height:200px}
  </style>
</head>
<body class="bg-slate-100">
<div class="max-w-6xl mx-auto p-4">
  <h1 class="text-2xl font-bold text-center mb-3">Pl√°novaƒç</h1>

  <!-- Nastaven√≠ Supabase -->
  <div class="bg-white border rounded-xl p-3 mb-3">
    <div class="flex flex-col md:flex-row gap-2">
      <input id="sb-url" class="border rounded px-2 py-1 flex-1" placeholder="Supabase URL (https://....supabase.co)">
      <input id="sb-key" class="border rounded px-2 py-1 flex-1" placeholder="Supabase anon key (ey...)">
      <input id="ws"     class="border rounded px-2 py-1 w-48" placeholder="workspace" value="public-demo">
      <button id="connect" class="border rounded px-3 py-1 bg-slate-50">P≈ôipojit</button>
    </div>
    <p class="text-xs text-slate-500 mt-2">Hodnoty se ulo≈æ√≠ do prohl√≠≈æeƒçe (localStorage). Sd√≠lej URL s <code>?w=team-a</code>, a≈• jste ve stejn√© m√≠stnosti.</p>
  </div>

  <!-- Ovl√°d√°n√≠ -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-4">
    <div class="bg-white border rounded-xl p-3">
      <div class="font-semibold mb-2">P≈ôidat SPZ</div>
      <div class="flex gap-2">
        <input id="spz" class="border rounded px-2 py-1 flex-1" placeholder="SPZ (p√≠smena i ƒç√≠sla)">
        <button id="addSpz" class="border rounded px-3 py-1 bg-slate-50">P≈ôidat SPZ</button>
      </div>
    </div>
    <div class="bg-white border rounded-xl p-3">
      <div class="font-semibold mb-2">P≈ôidat st√°t (sloupec)</div>
      <div class="flex gap-2">
        <input id="newCountry" class="border rounded px-2 py-1 flex-1 uppercase" placeholder="Nap≈ô. PL, AT, SK">
        <button id="addCountry" class="border rounded px-3 py-1 bg-slate-50">P≈ôidat st√°t</button>
      </div>
    </div>
  </div>

  <!-- Board -->
  <div id="board" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-3"></div>

  <p class="text-xs text-slate-500 mt-4">
    üîó Realtime ‚Äì cokoliv uprav√≠≈°, uvid√≠ v≈°ichni okam≈æitƒõ.  
    üíæ Data jsou v Supabase tabulce <code>plans</code> (jedna ≈ô√°dka na workspace, JSON v poli <code>data</code>).  
  </p>
</div>

<script>
(function(){
  const { createClient } = window.supabase;

  // --- UI refs
  const elUrl = document.getElementById('sb-url');
  const elKey = document.getElementById('sb-key');
  const elWs  = document.getElementById('ws');
  const elConn= document.getElementById('connect');
  const elSpz = document.getElementById('spz');
  const elAddSpz = document.getElementById('addSpz');
  const elNewCountry = document.getElementById('newCountry');
  const elAddCountry = document.getElementById('addCountry');
  const elBoard = document.getElementById('board');

  // --- Local storage load
  const LS_URL = 'planner:supabase:url';
  const LS_KEY = 'planner:supabase:key';
  elUrl.value = localStorage.getItem(LS_URL) || '';
  elKey.value = localStorage.getItem(LS_KEY) || '';
  // workspace z URL
  const qs = new URLSearchParams(location.search);
  if(qs.get('w')) elWs.value = qs.get('w');

  let supa = null;
  let channel = null;
  let state = {
    countries: ["CZ","DE","FR","IT","ES","NL","BE"],
    bubbles: []
  };
  let workspace = elWs.value.trim() || 'public-demo';
  let isReady = false;

  // --- Render board
  function render(){
    elBoard.innerHTML = '';
    const groups = {};
    for(const c of state.countries) groups[c] = [];
    for(const b of state.bubbles){
      (groups[b.column] || (groups[b.column]=[])).push(b);
    }
    for(const c of state.countries){
      const col = document.createElement('div');
      col.className = 'bg-white/70 backdrop-blur border rounded-2xl p-2 col';
      col.innerHTML = `<div class="font-bold text-center mb-2">${c}</div>`;
      const list = document.createElement('div');
      list.className = 'flex flex-col gap-2';
      (groups[c]||[]).forEach(b => list.appendChild(renderBubble(b)));
      col.appendChild(list);
      // drag & drop
      col.addEventListener('dragover', e => e.preventDefault());
      col.addEventListener('drop', async e => {
        const id = e.dataTransfer.getData('text/plain'); if(!id) return;
        const idx = state.bubbles.findIndex(x=>x.id===id); if(idx===-1) return;
        state.bubbles[idx].column = c;
        await save();
      });
      elBoard.appendChild(col);
    }
  }

  function renderBubble(b){
    const wrap = document.createElement('div');
    wrap.className = 'bg-white rounded-xl shadow p-2 select-none';
    wrap.draggable = true;
    wrap.addEventListener('dragstart', e => e.dataTransfer.setData('text/plain', b.id));

    const row = document.createElement('div');
    row.className = 'flex items-center gap-2';
    const spz = document.createElement('span'); spz.className='font-semibold'; spz.textContent=b.label;
    const sel = document.createElement('select'); sel.className='border rounded px-1 text-xs';
    sel.innerHTML = ['','Po','√öt','St','ƒåt','P√°','So','Ne'].map(d=>`<option value="${d}">${d||'Den'}</option>`).join('');
    sel.value = b.day || '';
    sel.onchange = async ()=>{ b.day = sel.value; await save(); };

    const btnX = document.createElement('button'); btnX.textContent='‚úï'; btnX.className='text-red-500 text-xs';
    btnX.onclick = async ()=>{ b.day=''; await save(); };

    row.appendChild(spz); row.appendChild(sel); if(b.day) row.appendChild(btnX);

    const note = document.createElement('input'); note.className='border rounded px-1 text-xs w-full mt-1';
    note.placeholder='Pozn√°mka‚Ä¶'; note.value=b.note||'';
    note.onfocus = e => e.target.select();
    note.oninput = async ()=>{ b.note = note.value; await save(); };

    wrap.appendChild(row); wrap.appendChild(note);
    return wrap;
  }

  // --- DB helpers
  async function load(){
    const { data, error } = await supa
      .from('plans')
      .select('data, updated_at')
      .eq('id', workspace)
      .maybeSingle();
    if(error){ console.error(error); return; }
    if(!data){
      // vytvo≈ô pr√°zdn√Ω dokument
      await supa.from('plans').insert({ id: workspace, data: state });
      return load();
    }
    const doc = data.data || {};
    state.countries = Array.isArray(doc.countries) ? doc.countries : state.countries;
    state.bubbles   = Array.isArray(doc.bubbles)   ? doc.bubbles   : [];
    render();
  }

  async function save(){
    // merge na serveru: upsert JSON dokumentu
    const { error } = await supa
      .from('plans')
      .upsert({ id: workspace, data: state, updated_at: new Date().toISOString() })
      .select();
    if(error) console.error(error);
  }

  function subscribe(){
    if(channel) { supa.removeChannel(channel); channel = null; }
    channel = supa.channel('realtime:plans')
      .on('postgres_changes',
          { event: '*', schema: 'public', table: 'plans', filter: `id=eq.${workspace}` },
          (payload) => {
            const doc = payload.new?.data;
            if(doc){
              state.countries = Array.isArray(doc.countries) ? doc.countries : state.countries;
              state.bubbles   = Array.isArray(doc.bubbles)   ? doc.bubbles   : state.bubbles;
              render();
            }
          })
      .subscribe();
  }

  // --- Connect button
  elConn.onclick = async ()=>{
    const url = elUrl.value.trim();
    const key = elKey.value.trim();
    workspace = (elWs.value.trim() || 'public-demo');
    if(!url || !key){ alert('Vypl≈à Supabase URL a anon key.'); return; }
    localStorage.setItem(LS_URL, url);
    localStorage.setItem(LS_KEY, key);
    supa = createClient(url, key, { realtime: { params: { eventsPerSecond: 5 } } });
    // p≈ôepi≈° URL s ?w=
    const p = new URLSearchParams(location.search); p.set('w', workspace);
    history.replaceState(null,'',`?${p.toString()}`);
    await load();
    subscribe();
    isReady = true;
  };

  // --- rychl√© akce
  elAddSpz.onclick = async ()=>{
    if(!isReady) return alert('Nejprve P≈ôipojit k Supabase.');
    const label = elSpz.value.trim();
    if(!label) return;
    const id = 'spz-' + Math.random().toString(36).slice(2,8);
    state.bubbles.push({ id, label, type:'spz', column: state.countries[0]||'CZ', day:'', note:'' });
    elSpz.value = '';
    await save();
  };

  elAddCountry.onclick = async ()=>{
    if(!isReady) return alert('Nejprve P≈ôipojit k Supabase.');
    const code = elNewCountry.value.trim().toUpperCase();
    if(!code) return;
    if(!state.countries.includes(code)) state.countries.push(code);
    elNewCountry.value='';
    await save();
  };

  // auto-connect pokud jsou v LS kredenci√°ly
  if(elUrl.value && elKey.value){
    elConn.click();
  }
})();
</script>
</body>
</html>
