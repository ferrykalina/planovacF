<!doctype html>
<html lang="cs">
  <head>
    <meta charset="utf-8" />
    <title>Plánovač</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  </head>
  <body class="bg-slate-100">
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useEffect, useMemo, useRef } = React;

      const DAY_LABELS = ["Po", "Út", "St", "Čt", "Pá", "So", "Ne"];

      function Bubble({ b, onChangeDay, onChangeNote, onDeleteDay }) {
        return (
          <div className="bg-white rounded-xl shadow p-2 flex flex-col gap-1 select-none">
            <div className="flex items-center gap-2">
              <span className="font-semibold">{b.label}</span>
              <select
                value={b.day || ""}
                onChange={(e) => onChangeDay(b.id, e.target.value)}
                className="border rounded px-1 text-xs"
              >
                <option value="">Den</option>
                {DAY_LABELS.map((d) => (
                  <option key={d} value={d}>
                    {d}
                  </option>
                ))}
              </select>
              {b.day && (
                <button
                  onClick={() => onDeleteDay(b.id)}
                  className="text-red-500 text-xs ml-1"
                >
                  ✕
                </button>
              )}
            </div>
            <input
              value={b.note || ""}
              onChange={(e) => onChangeNote(b.id, e.target.value)}
              onFocus={(e) => e.target.select()}
              placeholder="Poznámka…"
              className="border rounded px-1 text-xs"
            />
          </div>
        );
      }

      function CountryColumn({ code, children, onDrop }) {
        return (
          <div
            className="bg-white/70 backdrop-blur border rounded-2xl p-2 min-h-[200px]"
            onDragOver={(e) => e.preventDefault()}
            onDrop={(e) => onDrop(e, code)}
          >
            <div className="font-bold mb-2 text-center">{code}</div>
            <div className="flex flex-col gap-2">{children}</div>
          </div>
        );
      }

      function App() {
        const [countries, setCountries] = useState([
          "CZ",
          "DE",
          "FR",
          "IT",
          "ES",
          "NL",
          "BE",
        ]);
        const [bubbles, setBubbles] = useState([]);
        const [spz, setSpz] = useState("");
        const [workspace, setWorkspace] = useState("public-demo");

        const lastServerStampRef = useRef(0);
        const lastLocalChangeRef = useRef(0);

        const touchLocal = () => {
          lastLocalChangeRef.current = Date.now();
        };

        // --- PULL s unionem ---
        const pull = async (wid) => {
          try {
            const url = `/api/planovac/${encodeURIComponent(wid)}?t=${Date.now()}`;
            const r = await fetch(url, {
              cache: "no-store",
              headers: { "Cache-Control": "no-cache", Pragma: "no-cache" },
            });
            if (!r.ok) return;
            const data = await r.json();
            const serverCountries = Array.isArray(data.countries)
              ? data.countries
              : countries;
            const serverBubbles = Array.isArray(data.bubbles)
              ? data.bubbles
              : [];

            // --- union server + local ---
            const srvMap = new Map(serverBubbles.map((b) => [b.id, b]));
            const localOnly = bubbles.filter((b) => !srvMap.has(b.id));
            const mergedBubbles = [...serverBubbles, ...localOnly];

            setCountries(serverCountries);
            setBubbles(mergedBubbles);

            if (data && data.updated_at) {
              const stamp = Date.parse(data.updated_at);
              if (!Number.isNaN(stamp)) lastServerStampRef.current = stamp;
            }
          } catch (e) {
            console.error("GET failed", e);
          }
        };

        // --- PUSH ---
        const push = async (wid, payload) => {
          try {
            await fetch(`/api/planovac/${encodeURIComponent(wid)}`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json; charset=utf-8",
              },
              body: JSON.stringify(payload),
            });
          } catch (e) {
            console.error("POST failed", e);
          }
        };

        // auto-pull každé 3 s
        useEffect(() => {
          pull(workspace);
          const iv = setInterval(() => pull(workspace), 3000);
          return () => clearInterval(iv);
        }, [workspace]);

        // auto-push při změnách
        useEffect(() => {
          if (!bubbles.length) return;
          const t = setTimeout(() => {
            push(workspace, { countries, bubbles });
          }, 500);
          return () => clearTimeout(t);
        }, [countries, bubbles, workspace]);

        const addSpz = () => {
          const label = spz.trim();
          if (!label) return;
          const id = "spz-" + Math.random().toString(36).slice(2, 8);
          const newBubble = {
            id,
            label,
            type: "spz",
            column: countries[0],
            day: "",
            note: "",
          };
          setBubbles((prev) => [...prev, newBubble]);
          setSpz("");
          push(workspace, { countries, bubbles: [...bubbles, newBubble] });
        };

        const updateDay = (id, day) => {
          touchLocal();
          setBubbles((prev) =>
            prev.map((b) => (b.id === id ? { ...b, day } : b))
          );
        };
        const deleteDay = (id) => {
          touchLocal();
          setBubbles((prev) =>
            prev.map((b) => (b.id === id ? { ...b, day: "" } : b))
          );
        };
        const updateNote = (id, note) => {
          touchLocal();
          setBubbles((prev) =>
            prev.map((b) => (b.id === id ? { ...b, note } : b))
          );
        };

        const moveToColumn = (e, code) => {
          const id = e.dataTransfer.getData("text/plain");
          if (!id) return;
          setBubbles((prev) =>
            prev.map((b) => (b.id === id ? { ...b, column: code } : b))
          );
        };

        const byColumn = useMemo(() => {
          const map = Object.fromEntries(countries.map((c) => [c, []]));
          bubbles.forEach((b) => {
            if (!map[b.column]) map[b.column] = [];
            map[b.column].push(b);
          });
          return map;
        }, [bubbles, countries]);

        return (
          <div className="p-4 max-w-6xl mx-auto">
            <h1 className="text-2xl font-bold text-center mb-4">Plánovač</h1>
            <div className="flex gap-2 mb-4">
              <input
                value={spz}
                onChange={(e) => setSpz(e.target.value)}
                placeholder="Zadej SPZ"
                className="border rounded px-2 py-1 flex-1"
              />
              <button
                onClick={addSpz}
                className="border rounded px-3 py-1 bg-slate-50"
              >
                Přidat SPZ
              </button>
            </div>
            <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-3">
              {countries.map((c) => (
                <CountryColumn key={c} code={c} onDrop={moveToColumn}>
                  {byColumn[c].map((b) => (
                    <div
                      key={b.id}
                      draggable
                      onDragStart={(e) =>
                        e.dataTransfer.setData("text/plain", b.id)
                      }
                    >
                      <Bubble
                        b={b}
                        onChangeDay={updateDay}
                        onChangeNote={updateNote}
                        onDeleteDay={deleteDay}
                      />
                    </div>
                  ))}
                </CountryColumn>
              ))}
            </div>
          </div>
        );
      }

      ReactDOM.createRoot(document.getElementById("root")).render(<App />);
    </script>
  </body>
</html>
