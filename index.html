<!doctype html>
<html lang="cs">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>Plánovač</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#f6f7fb;margin:0;padding:24px;}
      .wrap{max-width:1200px;margin:0 auto}
      .card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;padding:16px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
      .cols{display:grid;grid-template-columns:repeat(1,minmax(0,1fr));gap:12px}
      @media(min-width:900px){.cols{grid-template-columns:repeat(7,minmax(0,1fr))}}
      .col{min-height:280px;background:#fff;border:1px solid #e5e7eb;border-radius:16px;padding:12px}
      .col h3{margin:4px 0 8px;text-align:center}
      .bubble{border:1px solid #e5e7eb;background:#fff;border-radius:14px;padding:8px 10px;margin:8px 0}
      .row{display:flex;flex-wrap:wrap;gap:6px;align-items:center}
      input[type=text], select{border:1px solid #cbd5e1;border-radius:8px;padding:6px 8px;font-size:12px}
      button{border:1px solid #cbd5e1;background:#fff;border-radius:10px;padding:8px 10px;cursor:pointer}
      button:hover{background:#f8fafc}
      .note{width:100%}
      small{color:#64748b}
      .toolbar{display:flex;flex-wrap:wrap;gap:12px;align-items:center;justify-content:center;margin:8px 0 16px}
      .grid{display:grid;grid-template-columns:1fr;gap:12px}
      @media(min-width:900px){.grid{grid-template-columns:1fr 1fr}}
      .draggable{cursor:grab}
    </style>
    <!-- React + ReactDOM + Babel -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script crossorigin src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
  </head>
  <body>
    <div class="wrap" id="root"></div>

    <script type="text/babel">
      const DAY_LABELS = ["Po","Út","St","Čt","Pá","So","Ne"];

      function Bubble({b,onChangeNote,onChangeDay,onDeleteDay,onDragStart}) {
        return (
          <div className="bubble draggable" draggable onDragStart={(e)=>onDragStart(e,b.id)} title="Poznámka jde dvojklikem označit a přepsat">
            <div className="row">
              <small>SPZ</small><strong>{b.label}</strong>
              <select value={b.day || ""} onChange={(e)=>onChangeDay(b.id, e.target.value || "")}>
                <option value="" disabled>Den</option>
                {DAY_LABELS.map(d => <option key={d} value={d}>{d}</option>)}
              </select>
              {b.day ? <button onClick={()=>onDeleteDay(b.id)}>×</button> : null}
            </div>
            <div className="row" style={{marginTop:6}}>
              <input className="note" type="text" value={b.note || ""} placeholder="Poznámka…"
                     onFocus={(e)=>e.target.select()} onChange={(e)=>onChangeNote(b.id,e.target.value)} />
            </div>
          </div>
        );
      }

      function App(){
        const urlParams = new URLSearchParams(location.search);
        const initialW = urlParams.get("w") || "public-demo";

        const [workspace, setWorkspace] = React.useState(initialW);
        const [countries, setCountries] = React.useState(["CZ","DE","FR","IT","ES","NL","BE"]);
        const [bubbles, setBubbles]   = React.useState([]);
        const [spz, setSpz] = React.useState("");
        const [newCountry,setNewCountry] = React.useState("");
        const [autoRefresh, setAutoRefresh] = React.useState(true);

        // Ochrany proti závodu + dirty flag
        const lastLocalChangeRef = React.useRef(0);
        const lastServerStampRef = React.useRef(0);
        const dirtyRef = React.useRef(false);

        const touchLocal = () => { lastLocalChangeRef.current = Date.now(); dirtyRef.current = true; };

        const byCol = React.useMemo(()=>{
          const map = Object.fromEntries(countries.map(c=>[c,[]]));
          for(const b of bubbles){ (map[b.column]||(map[b.column]=[])).push(b); }
          return map;
        },[countries,bubbles]);

        // PULL (no-cache + ochrana)
        const pull = async (wid) => {
          try {
            if (Date.now() - lastLocalChangeRef.current < 1500) return; // nedávná lokální změna → nepřepisuj
            const url = `/api/planovac/${encodeURIComponent(wid)}?t=${Date.now()}`;
            const r = await fetch(url, { cache:'no-store', headers: { 'Cache-Control':'no-cache', 'Pragma':'no-cache' } });
            if(!r.ok){ console.error("GET", r.status); return; }
            const data = await r.json();
            const stamp = data && data.updated_at ? Date.parse(data.updated_at) : 0;
            if (stamp && stamp < lastServerStampRef.current) return; // server poslal starší verzi → ignoruj
            if(Array.isArray(data.countries)) setCountries(data.countries);
            if(Array.isArray(data.bubbles))   setBubbles(data.bubbles);
            if (stamp) lastServerStampRef.current = stamp;
            // důležité: pull NEMĚNÍ dirtyRef (pull nemá spouštět push)
          } catch(e){ console.error("GET failed", e); }
        };

        // PUSH (jen když je dirty)
        const push = async (wid, payload) => {
          try {
            if (!dirtyRef.current) return; // nic se lokálně neměnilo → neposílej
            const r = await fetch(`/api/planovac/${encodeURIComponent(wid)}`, {
              method:'POST',
              headers:{'Content-Type':'application/json; charset=utf-8'},
              body: JSON.stringify(payload)
            });
            if(!r.ok) { console.error("POST", r.status); return; }
            dirtyRef.current = false; // úspěšně zapsáno
            await pull(wid);          // hned načti nejnovější serverová data
          } catch(e){ console.error("POST failed", e); }
        };

        // start: načti při změně workspace
        React.useEffect(()=>{ pull(workspace); },[workspace]);

        // polling: 3 s (pro sdílení mezi okny)
        React.useEffect(()=>{
          if(!autoRefresh) return;
          const id = setInterval(()=>pull(workspace), 3000);
          return ()=>clearInterval(id);
        },[workspace,autoRefresh]);

        // refresh při návratu/scrollu
        React.useEffect(()=>{
          const onFocus = ()=>pull(workspace);
          const onVisible = ()=>{ if(document.visibilityState==='visible') pull(workspace); };
          const onScroll = ()=>pull(workspace);
          window.addEventListener('focus', onFocus);
          document.addEventListener('visibilitychange', onVisible);
          window.addEventListener('scroll', onScroll, { passive:true });
          return ()=>{
            window.removeEventListener('focus', onFocus);
            document.removeEventListener('visibilitychange', onVisible);
            window.removeEventListener('scroll', onScroll);
          };
        },[workspace]);

        // autosave (debounce 300 ms) – PUSH jen když je dirty
        React.useEffect(()=>{
          const t = setTimeout(()=>push(workspace, { countries, bubbles }), 300);
          return ()=>clearTimeout(t);
        },[countries,bubbles,workspace]);

        // Mutátory – všechny označí dirty
        const addSpz = () => {
          const label = (spz||"").trim();
          if(!label) return;
          const id = "spz-" + Math.random().toString(36).slice(2,8);
          touchLocal();
          setBubbles(prev => [...prev, { id, label, type:'spz', column: countries[0]||"CZ", day:"", note:"" }]);
          setSpz("");
        };
        const addCountry = () => {
          const code = (newCountry||"").trim().toUpperCase();
          if(!code) return;
          if(countries.includes(code)){ setNewCountry(""); return; }
          touchLocal();
          setCountries(prev => [...prev, code]);
          setNewCountry("");
        };
        const onChangeNote = (id, text) => { touchLocal(); setBubbles(prev => prev.map(b=>b.id===id?{...b,note:text}:b)); };
        const onChangeDay  = (id, day)  => { touchLocal(); setBubbles(prev => prev.map(b=>b.id===id?{...b,day:day}:b)); };
        const onDeleteDay  = (id)       => { touchLocal(); setBubbles(prev => prev.map(b=>b.id===id?{...b,day:""}:b)); };
        const onDragStart  = (e, id)    => e.dataTransfer.setData("text/plain", id);
        const onDropTo     = (e, code)  => {
          const id = e.dataTransfer.getData("text/plain"); if(!id) return;
          touchLocal();
          setBubbles(prev => prev.map(b=>b.id===id?{...b,column:code}:b));
        };

        return (
          <div className="wrap">
            <header style={{textAlign:'center', marginBottom:12}}>
              <h1>Plánovač</h1>
              <small>Sdílej stejný odkaz se stejným <code>?w=...</code>. Změny se propsíší každé 3 s.</small>
            </header>

            <div className="toolbar">
              <label>Pracovní prostor (ID):
                <input type="text" value={workspace} onChange={e=>setWorkspace(e.target.value.trim()||"public-demo")} style={{marginLeft:6}} />
              </label>
              <label style={{display:'inline-flex',alignItems:'center',gap:6}}>
                <input type="checkbox" checked={autoRefresh} onChange={e=>setAutoRefresh(e.target.checked)} />
                Auto-refresh 3 s
              </label>
            </div>

            <div className="grid">
              <div className="card">
                <div style={{fontWeight:600, marginBottom:8}}>Přidat SPZ</div>
                <div className="row">
                  <input type="text" value={spz} onChange={e=>setSpz(e.target.value)} placeholder="SPZ (písmena i čísla)" />
                  <button onClick={addSpz}>Přidat SPZ</button>
                </div>
              </div>

              <div className="card">
                <div style={{fontWeight:600, marginBottom:8}}>Přidat stát (sloupec)</div>
                <div className="row">
                  <input type="text" value={newCountry} onChange={e=>setNewCountry(e.target.value.toUpperCase())} placeholder="Např. PL, AT, SK" />
                  <button onClick={addCountry}>Přidat stát</button>
                </div>
                <small>Sloupec pro přesouvání SPZ (dvoupísmenná zkratka).</small>
              </div>
            </div>

            <div className="cols" style={{marginTop:16}}>
              {countries.map(code => (
                <div key={code} className="col" onDragOver={e=>e.preventDefault()} onDrop={(e)=>onDropTo(e, code)}>
                  <h3>{code}</h3>
                  {(byCol[code]||[]).map(b => (
                    <Bubble key={b.id} b={b}
                      onChangeNote={onChangeNote}
                      onChangeDay={onChangeDay}
                      onDeleteDay={onDeleteDay}
                      onDragStart={onDragStart}
                    />
                  ))}
                </div>
              ))}
            </div>

            <div style={{marginTop:16}}>
              <small>🧭 Přidej SPZ, vyber den v bublině, připiš poznámku. Přetáhni do správného státu.  
              🔗 Používejte stejný <code>?w=…</code>.  
              ⏱️ Sync: polling 3 s, anti-cache, dirty-push (bez přepisování).</small>
            </div>
          </div>
        );
      }

      ReactDOM.createRoot(document.getElementById("root")).render(<App />);
    </script>
  </body>
</html>
