<!doctype html>
<html lang="cs">
  <head>
    <!-- DŮLEŽITÉ: UTF-8 musí být úplně nahoře -->
    <meta charset="UTF-8" />
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>Plánovač</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#f6f7fb;margin:0;padding:24px;}
      .wrap{max-width:1200px;margin:0 auto}
      .card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;padding:16px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
      .cols{display:grid;grid-template-columns:repeat(1,minmax(0,1fr));gap:12px}
      @media(min-width:900px){.cols{grid-template-columns:repeat(7,minmax(0,1fr))}}
      .col{min-height:280px;background:#fff;border:1px solid #e5e7eb;border-radius:16px;padding:12px}
      .col h3{margin:4px 0 8px;text-align:center}
      .bubble{border:1px solid #e5e7eb;background:#fff;border-radius:14px;padding:8px 10px;margin:8px 0}
      .row{display:flex;flex-wrap:wrap;gap:6px;align-items:center}
      input[type=text], select{border:1px solid #cbd5e1;border-radius:8px;padding:6px 8px;font-size:12px}
      button{border:1px solid #cbd5e1;background:#fff;border-radius:10px;padding:8px 10px;cursor:pointer}
      button:hover{background:#f8fafc}
      .note{width:100%}
      small{color:#64748b}
      .toolbar{display:flex;flex-wrap:wrap;gap:12px;align-items:center;justify-content:center;margin:8px 0 16px}
      .grid{display:grid;grid-template-columns:1fr;gap:12px}
      @media(min-width:900px){.grid{grid-template-columns:1fr 1fr}}
      .draggable{cursor:grab}
    </style>
    <!-- React + ReactDOM + Babel (bez buildu) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script crossorigin src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
  </head>
  <body>
    <div class="wrap" id="root"></div>

    <script type="text/babel">
      const DAY_LABELS = ["Po","Út","St","Čt","Pá","So","Ne"];

      function Bubble({b,onChangeNote,onChangeDay,onDeleteDay,onDragStart}) {
        return (
          <div className="bubble draggable" draggable onDragStart={(e)=>onDragStart(e,b.id)} title="Poznámka jde dvojklikem označit a přepsat">
            <div className="row">
              <small>SPZ</small><strong>{b.label}</strong>
              <select value={b.day || ""} onChange={(e)=>onChangeDay(b.id, e.target.value || "")}>
                <option value="" disabled>Den</option>
                {DAY_LABELS.map(d => <option key={d} value={d}>{d}</option>)}
              </select>
              {b.day ? <button onClick={()=>onDeleteDay(b.id)}>×</button> : null}
            </div>
            <div className="row" style={{marginTop:6}}>
              <input className="note" type="text" value={b.note || ""} placeholder="Poznámka…"
                     onFocus={(e)=>e.target.select()} onChange={(e)=>onChangeNote(b.id,e.target.value)} />
            </div>
          </div>
        );
      }

      function App(){
        const urlParams = new URLSearchParams(location.search);
        const initialW = urlParams.get("w") || "public-demo";
        const [workspace, setWorkspace] = React.useState(initialW);
        const [countries, setCountries] = React.useState(["CZ","DE","FR","IT","ES","NL","BE"]);
        const [bubbles, setBubbles]   = React.useState([]);
        const [spz, setSpz] = React.useState("");
        const [newCountry,setNewCountry] = React.useState("");
        // autoRefresh zapnutý defaultně a kratší interval (5 s)
        const [autoRefresh, setAutoRefresh] = React.useState(true);

        const byCol = React.useMemo(()=>{
          const map = Object.fromEntries(countries.map(c=>[c,[]]));
          for(const b of bubbles){ (map[b.column]||(map[b.column]=[])).push(b); }
          return map;
        },[countries,bubbles]);

        const pull = async (wid) => {
          try {
            const r = await fetch(`/api/planovac/${encodeURIComponent(wid)}`, {cache:'no-store'});
            if(!r.ok){ console.error("GET", r.status); return; }
            const data = await r.json();
            if(Array.isArray(data.countries)) setCountries(data.countries);
            if(Array.isArray(data.bubbles)) setBubbles(data.bubbles);
          } catch(e){ console.error("GET failed", e); }
        };

        const push = async (wid, payload) => {
          try {
            const r = await fetch(`/api/planovac/${encodeURIComponent(wid)}`, {
              method:'POST', headers:{'Content-Type':'application/json; charset=utf-8'},
              body: JSON.stringify(payload)
            });
            if(!r.ok) console.error("POST", r.status);
            // po uložení hned stáhni, aby ostatní uviděli změny co nejdřív
            pull(wid);
          } catch(e){ console.error("POST failed", e); }
        };

        // start: načti
        React.useEffect(()=>{ pull(workspace); },[workspace]);

        // rychlý polling: každých 5 s (když je zaškrtnuto)
        React.useEffect(()=>{
          if(!autoRefresh) return;
          const id = setInterval(()=>pull(workspace), 5000);
          return ()=>clearInterval(id);
        },[workspace,autoRefresh]);

        // také stáhni při návratu do okna/záložky
        React.useEffect(()=>{
          const onFocus = ()=>pull(workspace);
          const onVisible = ()=>{ if(document.visibilityState==='visible') pull(workspace); };
          window.addEventListener('focus', onFocus);
          document.addEventListener('visibilitychange', onVisible);
          return ()=>{
            window.removeEventListener('focus', onFocus);
            document.removeEventListener('visibilitychange', onVisible);
          };
        },[workspace]);

        // auto-save (debounce 300 ms) + UTF-8 JSON headery již výše
        React.useEffect(()=>{
          const t = setTimeout(()=>push(workspace, { countries, bubbles }), 300);
          return ()=>clearTimeout(t);
        },[countries,bubbles,workspace]);

        const addSpz = () => {
          const label = (spz||"").trim();
          if(!label) return;
          const id = "spz-" + Math.random().toString(36).slice(2,8);
          setBubbles(prev => [...prev, { id, label, type:'spz', column: countries[0]||"CZ", day:"", note:"" }]);
          setSpz("");
        };
        const addCountry = () => {
          const code = (newCountry||"").trim().toUpperCase();
          if(!code) return;
          if(countries.includes(code)){ setNewCountry(""); return; }
          setCountries(prev => [...prev, code]);
          setNewCountry("");
        };

        const onChangeNote = (id, text) => setBubbles(prev => prev.map(b=>b.id===id?{...b,note:text}:b));
        const onChangeDay  = (id, day)  => setBubbles(prev => prev.map(b=>b.id===id?{...b,day:day}:b));
        const onDeleteDay  = (id)       => setBubbles(prev => prev.map(b=>b.id===id?{...b,day:""}:b));
        const onDragStart  = (e, id)    => e.dataTransfer.setData("text/plain", id);
        const onDropTo     = (e, code)  => {
          const id = e.dataTransfer.getData("text/plain"); if(!id) return;
          setBubbles(prev => prev.map(b=>b.id===id?{...b,column:code}:b));
        };

        return (
          <div className="wrap">
            <header style={{textAlign:'center', marginBottom:12}}>
              <h1>Plánovač</h1>
              <small>Veřejný online dokument – sdílej URL, kdokoliv může upravovat.</small>
            </header>

            <div className="toolbar">
              <label>Pracovní prostor (ID):
                <input type="text" value={workspace} onChange={e=>setWorkspace(e.target.value.trim()||"public-demo")} style={{marginLeft:6}} />
              </label>
              <label style={{display:'inline-flex',alignItems:'center',gap:6}}>
                <input type="checkbox" checked={autoRefresh} onChange={e=>setAutoRefresh(e.target.checked)} />
                Auto-refresh 5 s
              </label>
            </div>

            <div className="grid">
              <div className="card">
                <div style={{fontWeight:600, marginBottom:8}}>Přidat SPZ</div>
                <div className="row">
                  <input type="text" value={spz} onChange={e=>setSpz(e.target.value)} placeholder="SPZ (písmena i čísla)" />
                  <button onClick={addSpz}>Přidat SPZ</button>
                </div>
              </div>

              <div className="card">
                <div style={{fontWeight:600, marginBottom:8}}>Přidat stát (sloupec)</div>
                <div className="row">
                  <input type="text" value={newCountry} onChange={e=>setNewCountry(e.target.value.toUpperCase())} placeholder="Např. PL, AT, SK" />
                  <button onClick={addCountry}>Přidat stát</button>
                </div>
                <small>Sloupec pro přesouvání SPZ (dvoupísmenná zkratka).</small>
              </div>
            </div>

            <div className="cols" style={{marginTop:16}}>
              {countries.map(code => (
                <div key={code} className="col" onDragOver={e=>e.preventDefault()} onDrop={(e)=>onDropTo(e, code)}>
                  <h3>{code}</h3>
                  { (byCol[code]||[]).map(b => (
                    <Bubble key={b.id} b={b}
                      onChangeNote={onChangeNote}
                      onChangeDay={onChangeDay}
                      onDeleteDay={onDeleteDay}
                      onDragStart={onDragStart}
                    />
                  )) }
                </div>
              ))}
            </div>

            <div style={{marginTop:16}}>
              <small>🧭 Přidej SPZ, vyber den přímo v bublině, připiš poznámku. Přetáhni do správného státu.  
              🔗 Pro oddělené tabule použij <code>?w=team-a</code>.  
              ⏱️ Data se ukládají automaticky a sdílí se (polling 5 s).</small>
            </div>
          </div>
        );
      }

      ReactDOM.createRoot(document.getElementById("root")).render(<App />);
    </script>
  </body>
</html>
