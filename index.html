<!doctype html>
<html lang="cs">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>Pl√°novaƒç</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#f6f7fb;margin:0;padding:24px;}
      .wrap{max-width:1200px;margin:0 auto}
      .card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;padding:16px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
      .cols{display:grid;grid-template-columns:repeat(1,minmax(0,1fr));gap:12px}
      @media(min-width:900px){.cols{grid-template-columns:repeat(7,minmax(0,1fr))}}
      .col{min-height:280px;background:#fff;border:1px solid #e5e7eb;border-radius:16px;padding:12px}
      .col h3{margin:4px 0 8px;text-align:center}
      .bubble{border:1px solid #e5e7eb;background:#fff;border-radius:14px;padding:8px 10px;margin:8px 0}
      .row{display:flex;flex-wrap:wrap;gap:6px;align-items:center}
      input[type=text], select{border:1px solid #cbd5e1;border-radius:8px;padding:6px 8px;font-size:12px}
      button{border:1px solid #cbd5e1;background:#fff;border-radius:10px;padding:8px 10px;cursor:pointer}
      button:hover{background:#f8fafc}
      .note{width:100%}
      small{color:#64748b}
      .toolbar{display:flex;flex-wrap:wrap;gap:12px;align-items:center;justify-content:center;margin:8px 0 16px}
      .grid{display:grid;grid-template-columns:1fr;gap:12px}
      @media(min-width:900px){.grid{grid-template-columns:1fr 1fr}}
      .draggable{cursor:grab}
    </style>
    <!-- React + ReactDOM + Babel -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script crossorigin src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
  </head>
  <body>
    <div class="wrap" id="root"></div>

    <script type="text/babel">
      const DAY_LABELS = ["Po","√öt","St","ƒåt","P√°","So","Ne"];

      function Bubble({b,onChangeNote,onChangeDay,onDeleteDay,onDragStart}) {
        return (
          <div className="bubble draggable" draggable onDragStart={(e)=>onDragStart(e,b.id)} title="Pozn√°mka jde dvojklikem oznaƒçit a p≈ôepsat">
            <div className="row">
              <small>SPZ</small><strong>{b.label}</strong>
              <select value={b.day || ""} onChange={(e)=>onChangeDay(b.id, e.target.value || "")}>
                <option value="" disabled>Den</option>
                {DAY_LABELS.map(d => <option key={d} value={d}>{d}</option>)}
              </select>
              {b.day ? <button onClick={()=>onDeleteDay(b.id)}>√ó</button> : null}
            </div>
            <div className="row" style={{marginTop:6}}>
              <input className="note" type="text" value={b.note || ""} placeholder="Pozn√°mka‚Ä¶"
                     onFocus={(e)=>e.target.select()} onChange={(e)=>onChangeNote(b.id,e.target.value)} />
            </div>
          </div>
        );
      }

      function App(){
        const urlParams = new URLSearchParams(location.search);
        const initialW = urlParams.get("w") || "public-demo";

        const [workspace, setWorkspace] = React.useState(initialW);
        const [countries, setCountries] = React.useState(["CZ","DE","FR","IT","ES","NL","BE"]);
        const [bubbles, setBubbles]   = React.useState([]);
        const [spz, setSpz] = React.useState("");
        const [newCountry,setNewCountry] = React.useState("");
        const [autoRefresh, setAutoRefresh] = React.useState(true); // default zapnuto

        // --- Ochrany proti p≈ôeps√°n√≠ + dirty/union ---
        const lastLocalChangeRef = React.useRef(0);   // ƒças posledn√≠ lok√°ln√≠ zmƒõny
        const lastServerStampRef = React.useRef(0);   // posledn√≠ pou≈æit√© updated_at ze serveru
        const dirtyRef = React.useRef(false);         // zda m√°me neodeslan√© lok√°ln√≠ zmƒõny
        const suppressPullUntilRef = React.useRef(0); // do tohoto ƒçasu ignoruj pull
        const localNewIdsRef = React.useRef(new Map()); // Map<id, timestamp> novƒõ p≈ôidan√Ωch SPZ
        const LOCAL_KEEP_MS = 10000; // 10 s dr≈æet lok√°ln√≠ novinky (union), ne≈æ je server vr√°t√≠

        const touchLocal = () => { lastLocalChangeRef.current = Date.now(); dirtyRef.current = true; suppressPullUntilRef.current = Date.now() + 1200; };

        const byCol = React.useMemo(()=>{
          const map = Object.fromEntries(countries.map(c=>[c,[]]));
          for(const b of bubbles){ (map[b.column]||(map[b.column]=[])).push(b); }
          return map;
        },[countries,bubbles]);

        // --- PULL (no-cache + union + potlaƒçen√≠ po lok√°ln√≠ zmƒõnƒõ/pushi) ---
        const pull = async (wid) => {
          try {
            const now = Date.now();
            if (now < suppressPullUntilRef.current) return; // doƒçasnƒõ potlaƒçeno
            if (now - lastLocalChangeRef.current < 1200) return; // tƒõsnƒõ po lok√°ln√≠ zmƒõnƒõ nep≈ôepisuj

            const url = `/api/planovac/${encodeURIComponent(wid)}?t=${Date.now()}`;
            const r = await fetch(url, { cache:'no-store', headers: { 'Cache-Control':'no-cache', 'Pragma':'no-cache' } });
            if(!r.ok){ console.error("GET", r.status); return; }
            const data = await r.json();

            const stamp = data && data.updated_at ? Date.parse(data.updated_at) : 0;
            if (stamp && stamp < lastServerStampRef.current) return; // server pos√≠l√° star≈°√≠ verzi ‚Üí ignoruj

            let serverCountries = Array.isArray(data.countries) ? data.countries : countries;
            let serverBubbles   = Array.isArray(data.bubbles)   ? data.bubbles   : [];

            // vyh√°zej pro≈°l√© lok√°ln√≠ novinky
            for (const [id, t] of Array.from(localNewIdsRef.current.entries())) {
              if (Date.now() - t > LOCAL_KEEP_MS) localNewIdsRef.current.delete(id);
            }
            const srvMap = new Map(serverBubbles.map(b => [b.id, b]));
            const keepLocals = [];
            for (const [id] of localNewIdsRef.current.entries()) {
              if (!srvMap.has(id)) {
                const lb = bubbles.find(b => b.id === id);
                if (lb) keepLocals.push(lb);
              }
            }
            const mergedBubbles = keepLocals.length ? [...serverBubbles, ...keepLocals] : serverBubbles;

            setCountries(serverCountries);
            setBubbles(mergedBubbles);
            if (stamp) lastServerStampRef.current = stamp;
          } catch(e){ console.error("GET failed", e); }
        };

        // --- PUSH (jen kdy≈æ je dirty) ---
        const push = async (wid, payload) => {
          try {
            if (!dirtyRef.current) return;
            // po pushi na chv√≠li potlaƒç pull, aby nestihl p≈ôepsat
            suppressPullUntilRef.current = Date.now() + 1500;

            const r = await fetch(`/api/planovac/${encodeURIComponent(wid)}`, {
              method:'POST',
              headers:{'Content-Type':'application/json; charset=utf-8'},
              body: JSON.stringify(payload)
            });
            if(!r.ok) { console.error("POST", r.status); return; }
            dirtyRef.current = false;
            // kr√°tk√© zpo≈ædƒõn√≠ a pak naƒç√≠st (server u≈æ by mƒõl m√≠t novou verzi)
            setTimeout(()=>pull(wid), 250);
          } catch(e){ console.error("POST failed", e); }
        };

        // start: naƒçti p≈ôi zmƒõnƒõ workspace
        React.useEffect(()=>{ pull(workspace); },[workspace]);

        // polling: jen kdy≈æ je zapnut√Ω
        React.useEffect(()=>{
          if(!autoRefresh) return;
          const id = setInterval(()=>pull(workspace), 3000);
          return ()=>clearInterval(id);
        },[workspace,autoRefresh]);

        // eventy (focus/visibility/scroll) jen kdy≈æ je autoRefresh zapnut√Ω
        React.useEffect(()=>{
          if(!autoRefresh) return;
          const onFocus = ()=>pull(workspace);
          const onVisible = ()=>{ if(document.visibilityState==='visible') pull(workspace); };
          const onScroll = ()=>pull(workspace);
          window.addEventListener('focus', onFocus);
          document.addEventListener('visibilitychange', onVisible);
          window.addEventListener('scroll', onScroll, { passive:true });
          return ()=>{
            window.removeEventListener('focus', onFocus);
            document.removeEventListener('visibilitychange', onVisible);
            window.removeEventListener('scroll', onScroll);
          };
        },[workspace,autoRefresh]);

        // autosave (debounce 300 ms) ‚Äì po zmƒõnƒõ po≈°li, jinak nic
        React.useEffect(()=>{
          const t = setTimeout(()=>push(workspace, { countries, bubbles }), 300);
          return ()=>clearTimeout(t);
        },[countries,bubbles,workspace]);

        // --- Mut√°tory (v≈°echny oznaƒç√≠ dirty) ---
        const addSpz = () => {
          const label = (spz||"").trim();
          if(!label) return;
          const id = "spz-" + Math.random().toString(36).slice(2,8);
          const newBubble = { id, label, type:'spz', column: countries[0]||"CZ", day:"", note:"" };

          // zaznamenej lok√°ln√≠ zmƒõnu a novinku
          touchLocal();
          localNewIdsRef.current.set(id, Date.now());

          // lok√°lnƒõ p≈ôidej
          const next = [...bubbles, newBubble];
          setBubbles(next);
          setSpz("");

          // OKAM≈ΩIT√ù push s nov√Ωm polem
          (async ()=>{
            try {
              suppressPullUntilRef.current = Date.now() + 1500;
              await fetch(`/api/planovac/${encodeURIComponent(workspace)}`, {
                method:'POST', headers:{'Content-Type':'application/json; charset=utf-8'},
                body: JSON.stringify({ countries, bubbles: next })
              });
            } catch(e) {
              console.error("POST addSpz failed", e);
            } finally {
              dirtyRef.current = false;
              setTimeout(()=>pull(workspace), 250);
            }
          })();
        };

        const addCountry = () => {
          const code = (newCountry||"").trim().toUpperCase();
          if(!code) return;
          if(countries.includes(code)){ setNewCountry(""); return; }
          touchLocal();
          setCountries(prev => [...prev, code]);
          setNewCountry("");
        };

        const onChangeNote = (id, text) => { touchLocal(); setBubbles(prev => prev.map(b=>b.id===id?{...b,note:text}:b)); };
        const onChangeDay  = (id, day)  => { touchLocal(); setBubbles(prev => prev.map(b=>b.id===id?{...b,day:day}:b)); };
        const onDeleteDay  = (id)       => { touchLocal(); setBubbles(prev => prev.map(b=>b.id===id?{...b,day:""}:b)); };
        const onDragStart  = (e, id)    => e.dataTransfer.setData("text/plain", id);
        const onDropTo     = (e, code)  => {
          const id = e.dataTransfer.getData("text/plain"); if(!id) return;
          touchLocal();
          setBubbles(prev => prev.map(b=>b.id===id?{...b,column:code}:b));
        };

        return (
          <div className="wrap">
            <header style={{textAlign:'center', marginBottom:12}}>
              <h1>Pl√°novaƒç</h1>
              <small>Sd√≠lej stejn√Ω odkaz se stejn√Ωm <code>?w=...</code>. Zmƒõny se props√≠≈°√≠ bezpeƒçnƒõ (bez miznut√≠).</small>
            </header>

            <div className="toolbar">
              <label>Pracovn√≠ prostor (ID):
                <input type="text" value={workspace} onChange={e=>setWorkspace(e.target.value.trim()||"public-demo")} style={{marginLeft:6}} />
              </label>
              <label style={{display:'inline-flex',alignItems:'center',gap:6}}>
                <input type="checkbox" checked={autoRefresh} onChange={e=>setAutoRefresh(e.target.checked)} />
                Auto-refresh 3 s
              </label>
            </div>

            <div className="grid">
              <div className="card">
                <div style={{fontWeight:600, marginBottom:8}}>P≈ôidat SPZ</div>
                <div className="row">
                  <input type="text" value={spz} onChange={e=>setSpz(e.target.value)} placeholder="SPZ (p√≠smena i ƒç√≠sla)" />
                  <button onClick={addSpz}>P≈ôidat SPZ</button>
                </div>
              </div>

              <div className="card">
                <div style={{fontWeight:600, marginBottom:8}}>P≈ôidat st√°t (sloupec)</div>
                <div className="row">
                  <input type="text" value={newCountry} onChange={e=>setNewCountry(e.target.value.toUpperCase())} placeholder="Nap≈ô. PL, AT, SK" />
                  <button onClick={addCountry}>P≈ôidat st√°t</button>
                </div>
                <small>Sloupec pro p≈ôesouv√°n√≠ SPZ (dvoup√≠smenn√° zkratka).</small>
              </div>
            </div>

            <div className="cols" style={{marginTop:16}}>
              {countries.map(code => (
                <div key={code} className="col" onDragOver={e=>e.preventDefault()} onDrop={(e)=>onDropTo(e, code)}>
                  <h3>{code}</h3>
                  {(byCol[code]||[]).map(b => (
                    <Bubble key={b.id} b={b}
                      onChangeNote={onChangeNote}
                      onChangeDay={onChangeDay}
                      onDeleteDay={onDeleteDay}
                      onDragStart={onDragStart}
                    />
                  ))}
                </div>
              ))}
            </div>

            <div style={{marginTop:16}}>
              <small>üß≠ P≈ôidej SPZ, vyber den v bublinƒõ, p≈ôipi≈° pozn√°mku. P≈ôet√°hni do spr√°vn√©ho st√°tu.  
              üîó Pou≈æ√≠vejte stejn√© <code>?w=‚Ä¶</code>.  
              üõ°Ô∏è Z√°pis je okam≈æit√Ω, pull je chr√°nƒõn√Ω a dƒõl√° union ‚Üí bubliny u≈æ ‚Äûnemiz√≠‚Äú.</small>
            </div>
          </div>
        );
      }

      ReactDOM.createRoot(document.getElementById("root")).render(<App />);
    </script>
  </body>
</html>
